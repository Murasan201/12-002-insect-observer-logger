# システムアーキテクチャ設計書

**文書番号**: 12-002-ARCH-001  
**プロジェクト名**: 昆虫自動観察＆ログ記録アプリ  
**文書名**: システムアーキテクチャ設計書  
**バージョン**: 1.0  
**作成日**: 2025-07-25  
**作成者**: 開発チーム  

---

## 1. 文書概要

### 1.1 目的
本文書は昆虫自動観察＆ログ記録アプリケーションのシステム全体アーキテクチャを定義し、各構成要素の関係性と役割を明確化する。

### 1.2 適用範囲
- システム全体構成
- 各層の役割定義
- コンポーネント間の関係性
- 処理フローの全体設計

### 1.3 関連文書
- 要件定義書（12-002）
- 基本システム仕様書（system_specification.md）

---

## 2. システム全体構成

### 2.1 システム概要図

```
┌─────────────────────────────────────────────────────────────────────┐
│                    昆虫自動観察システム                              │
│                  Insect Observation System                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │                 │  │                 │  │                 │    │
│  │  ハードウェア層  │  │ アプリケーション層│  │    データ層     │    │
│  │  Hardware Layer │  │ Application Layer │  │   Data Layer    │    │
│  │                 │  │                 │  │                 │    │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │    │
│  │ │Raspberry Pi │ │  │ │   main.py   │ │  │ │   CSV Log   │ │    │
│  │ │     5       │ │◄─┼─│  統合制御    │ │◄─┼─│    Files    │ │    │
│  │ │             │ │  │ │             │ │  │ │             │ │    │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │    │
│  │                 │  │        │        │  │                 │    │
│  │ ┌─────────────┐ │  │        ▼        │  │ ┌─────────────┐ │    │
│  │ │Camera V3    │ │◄─┼─┌─────────────┐ │  │ │   Image     │ │    │
│  │ │NoIR (赤外線) │ │  │ │insect_      │ │──┼─│  Output     │ │    │
│  │ │             │ │  │ │detector.py  │ │  │ │ Directory   │ │    │
│  │ └─────────────┘ │  │ │  検出制御    │ │  │ └─────────────┘ │    │
│  │                 │  │ └─────────────┘ │  │                 │    │
│  │ ┌─────────────┐ │  │        │        │  │ ┌─────────────┐ │    │
│  │ │IR LED Ring  │ │◄─┘        ▼        │  │ │   Graph     │ │    │
│  │ │850nm FRS5CS │ │    ┌─────────────┐ │  │ │Images (PNG) │ │    │
│  │ │             │ │    │activity_    │ │──┼─│             │ │    │
│  │ └─────────────┘ │    │calculator.py│ │  │ └─────────────┘ │    │
│  │                 │    │ 活動量算出   │ │  │                 │    │
│  └─────────────────┘    └─────────────┘ │  └─────────────────┘    │
│                                         │                         │
└─────────────────────────────────────────┘                         │
                                                                     │
┌─────────────────────────────────────────────────────────────────────┤
│                      外部システム連携                               │
│                   External System Integration                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │   Hugging Face  │  │     GitHub      │  │   Roboflow      │    │
│  │  Model Hub      │  │   Repository    │  │   Dataset       │    │
│  │                 │  │                 │  │                 │    │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │    │
│  │ │beetle-      │ │  │ │Source Code  │ │  │ │Training     │ │    │
│  │ │detection    │ │  │ │Repository   │ │  │ │Dataset      │ │    │
│  │ │yolov8 Model │ │  │ │             │ │  │ │             │ │    │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │    │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 アーキテクチャ層定義

| 層名 | 英語名 | 主要機能 | 構成要素 |
|------|--------|----------|----------|
| **ハードウェア層** | Hardware Layer | 物理デバイスの制御と管理 | Raspberry Pi 5, Camera V3 NoIR, IR LED Ring |
| **アプリケーション層** | Application Layer | ビジネスロジックの実装 | 統合制御、検出処理、活動量算出 |
| **データ層** | Data Layer | データの永続化と出力 | CSV ログ、画像ファイル、グラフ画像 |
| **外部システム連携** | External Integration | 外部リソースとの連携 | モデル取得、ソースコード管理、データセット |

---

## 3. システム構成要素

### 3.1 ハードウェア層 (Hardware Layer)

#### 3.1.1 中央処理装置
- **Raspberry Pi 5**
  - 役割: システム全体の制御・処理実行
  - OS: Raspberry Pi OS
  - CPU: ARM Cortex-A76 (クアッドコア)
  - RAM: 4GB/8GB

#### 3.1.2 撮影装置
- **Camera Module V3 NoIR**
  - 役割: 昆虫の撮影（赤外線対応）
  - 解像度: 最大4608×2592
  - インターフェース: CSI-2
  - 特徴: 赤外線フィルターなし

#### 3.1.3 照明装置
- **IR LED Ring 850nm FRS5CS**
  - 役割: 夜間撮影用赤外線照明
  - 波長: 850nm
  - 制御: PWM調光対応
  - 接続: GPIO制御

### 3.2 アプリケーション層 (Application Layer)

#### 3.2.1 統合制御モジュール
```
main.py
├── システム初期化
├── 定期実行制御（60秒間隔）
├── エラーハンドリング
├── 各モジュール連携
└── 終了処理
```

#### 3.2.2 検出制御モジュール
```
insect_detector.py
├── カメラ制御
├── IR LED制御
├── YOLOv8モデル推論
├── 画像処理
└── 検出結果出力
```

#### 3.2.3 活動量算出モジュール 
```
activity_calculator.py
├── 検出データ解析
├── 移動距離計算
├── 統計処理
├── グラフ生成
└── レポート出力
```

### 3.3 データ層 (Data Layer)

#### 3.3.1 ログデータ
- **検出ログ (CSV)**: timestamp, x, y, confidence, detected_flag
- **活動統計 (CSV)**: date, total_detections, total_distance, peak_time

#### 3.3.2 画像データ
- **撮影画像**: 検出時の元画像（JPEG形式）
- **注釈画像**: バウンディングボックス付き画像（PNG形式）

#### 3.3.3 可視化データ
- **活動グラフ**: 時間別活動量チャート（PNG形式）
- **移動軌跡**: 移動パターンの可視化（PNG形式）

---

## 4. 処理フローアーキテクチャ

### 4.1 システム全体処理フロー

```
[システム起動]
        │
        ▼
    ┌─────────┐
    │ 初期化   │ ←── ・ハードウェア初期化
    │ 処理    │     ・設定ファイル読込
    └─────────┘     ・モデル読込
        │
        ▼
    ┌─────────┐
    │ メイン   │ ←── 60秒間隔での定期実行
    │ ループ   │     無限ループ処理
    └─────────┘
        │
        ▼
    ┌─────────┐
    │ 検出     │ ←── ・LED点灯
    │ 実行     │     ・撮影
    └─────────┘     ・推論
        │           ・ログ記録
        ▼
    ┌─────────┐
    │ 日次     │ ←── ・活動量算出
    │ 処理     │     ・グラフ生成
    └─────────┘     ・データ整理
        │
        ▼
    ┌─────────┐
    │ 終了     │ ←── ・リソース解放
    │ 処理     │     ・最終ログ出力
    └─────────┘
```

### 4.2 検出処理詳細フロー

```
[検出開始]
     │
     ▼
┌─────────┐
│IR LED   │ ←── GPIO PWM制御
│点灯     │     調光レベル設定
└─────────┘
     │
     ▼
┌─────────┐
│画像     │ ←── picamera2ライブラリ
│撮影     │     解像度: 1920×1080
└─────────┘     露出: 自動調整
     │
     ▼
┌─────────┐
│YOLOv8   │ ←── ultralytics推論
│推論     │     学習済みモデル使用
└─────────┘     信頼度閾値: 0.5
     │
     ▼
┌─────────┐
│結果     │ ←── 座標データ抽出
│処理     │     CSV形式でログ出力
└─────────┘     検出画像保存
     │
     ▼
┌─────────┐
│IR LED   │ ←── 省電力化
│消灯     │     GPIO制御
└─────────┘
```

---

## 5. コンポーネント間連携

### 5.1 モジュール依存関係

```
main.py (統合制御)
├── insect_detector.py
│   ├── hardware_controller.py
│   ├── ultralytics (YOLOv8)
│   └── cv2 (OpenCV)
├── activity_calculator.py
│   ├── pandas (データ処理)
│   ├── numpy (数値計算)
│   └── matplotlib (グラフ生成)
└── config.py (設定管理)
```

### 5.2 データフロー

```
カメラ撮影 → 画像データ → YOLOv8推論 → 検出結果
                                          │
                                          ▼
CSV ログ ← ログ記録 ← 座標抽出 ← 結果処理
   │
   ▼
データ読込 → 活動量算出 → グラフ生成 → PNG出力
```

### 5.3 制御フロー

```
main.py
├── タイマー制御 → insect_detector.py
├── 日次処理制御 → activity_calculator.py
├── エラー監視
└── システム状態管理
```

---

## 6. 非機能アーキテクチャ

### 6.1 性能アーキテクチャ

#### 6.1.1 応答性能設計
| 処理段階 | 目標時間 | 制約条件 |
|----------|----------|----------|
| カメラ撮影 | ≤ 1秒 | ハードウェア性能依存 |
| YOLOv8推論 | ≤ 3秒 | CPU最適化モデル使用 |
| ログ記録 | ≤ 0.1秒 | 非同期I/O処理 |
| 全体処理 | ≤ 5秒 | 60秒間隔実行に対して十分 |

#### 6.1.2 リソース使用設計
```
リソース監視体系
├── CPU使用率: 最大80%
├── メモリ使用量: 最大2GB
├── ディスク使用量: 1GB/日
└── 電力消費: 最大10W
```

### 6.2 可用性アーキテクチャ

#### 6.2.1 エラーハンドリング体系
```
エラー階層
├── レベル1: 一時的エラー (自動リトライ)
├── レベル2: 設定エラー (ログ出力後継続)
├── レベル3: 重大エラー (セーフモード移行)
└── レベル4: 致命的エラー (システム停止)
```

#### 6.2.2 復旧機能設計
- **自動復旧**: プロセス異常時の自動再起動
- **セーフモード**: 最小限の機能で動作継続
- **ヘルスチェック**: 定期的なシステム状態確認

### 6.3 保守性アーキテクチャ

#### 6.3.1 ログ管理体系
```
ログ分類
├── システムログ: 全体動作状況
├── 検出ログ: 検出結果データ
├── エラーログ: 異常事象記録
└── 性能ログ: 処理時間・リソース使用状況
```

#### 6.3.2 設定管理体系
- **階層化設定**: システム設定・ハードウェア設定・アプリケーション設定
- **設定検証**: 起動時の妥当性チェック
- **動的変更**: 一部設定の実行時変更対応

---

## 7. セキュリティアーキテクチャ

### 7.1 アクセス制御
```
権限管理
├── システム管理者 (root)
│   ├── ハードウェア制御権限
│   ├── システム設定変更権限
│   └── アプリケーション管理権限
└── 実行ユーザー (pi)
    ├── アプリケーション実行権限
    ├── データ読み書き権限
    └── ログ出力権限
```

### 7.2 データ保護
- **ローカル保存**: 外部ネットワーク依存なし
- **ファイル権限**: 適切なUnix権限設定
- **データ暗号化**: 必要に応じた機密データ保護

---

## 8. 拡張性アーキテクチャ

### 8.1 水平拡張性
```
拡張ポイント
├── 複数カメラ対応
├── 複数昆虫種検出
├── 環境センサー連携
└── リアルタイム配信機能
```

### 8.2 垂直拡張性
```
性能向上オプション
├── GPU活用 (Raspberry Pi 5 GPU)
├── エッジTPU連携
├── 処理並列化
└── キャッシュ機構導入
```

---

## 9. 運用アーキテクチャ

### 9.1 監視体系
```
監視階層
├── インフラ監視
│   ├── ハードウェア状態
│   ├── OS状態
│   └── ネットワーク状態
├── アプリケーション監視
│   ├── プロセス状態
│   ├── 処理性能
│   └── エラー発生状況
└── ビジネス監視
    ├── 検出成功率
    ├── データ品質
    └── 活動パターン分析
```

### 9.2 運用管理
- **自動化**: システム起動・停止の自動化
- **バックアップ**: 重要データの定期バックアップ
- **更新管理**: システム・アプリケーション更新管理
- **障害対応**: 障害発生時の対応手順標準化

---

## 10. 技術選定根拠

### 10.1 ハードウェア選定
| 項目 | 選定理由 |
|------|----------|
| Raspberry Pi 5 | ARM64アーキテクチャ、豊富なGPIO、コミュニティサポート |
| Camera V3 NoIR | 赤外線対応、高解像度、CSI-2高速インターフェース |
| IR LED 850nm | カメラ感度域、低消費電力、PWM制御対応 |

### 10.2 ソフトウェア選定
| 項目 | 選定理由 |
|------|----------|
| Python 3.9+ | 豊富なライブラリ、Raspberry Pi標準サポート |
| YOLOv8 | 高精度検出、CPU最適化、推論速度 |
| OpenCV | 画像処理標準、ハードウェア加速対応 |
| picamera2 | Raspberry Pi公式カメラライブラリ |

---

## 11. 移行・展開戦略

### 11.1 段階的実装計画
```
Phase 1: 基盤構築 (2週間)
├── ハードウェアセットアップ
├── 基本撮影機能
└── 検出機能実装

Phase 2: 機能拡張 (2週間)
├── IR LED制御
├── 活動量算出
└── 可視化機能

Phase 3: 運用機能 (1週間)
├── エラーハンドリング
├── 監視機能
└── 自動復旧機能
```

### 11.2 テスト戦略
- **単体テスト**: 各モジュールの個別機能テスト
- **統合テスト**: モジュール間連携テスト  
- **システムテスト**: 24時間連続動作テスト
- **受入テスト**: 要件定義書準拠確認

---

*文書バージョン: 1.0*  
*最終更新日: 2025-07-25*  
*承認者: 開発チーム*
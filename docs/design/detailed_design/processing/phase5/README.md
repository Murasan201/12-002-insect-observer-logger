# Phase 5: システム統合・制御モジュール処理説明書

**フェーズ番号**: Phase 5  
**フェーズ名**: システム統合・制御モジュール  
**説明**: 各モジュール間の連携制御とシステム全体のライフサイクル管理を行うモジュール群  
**作成日**: 2025-07-29  
**文書バージョン**: 1.0  

---

## 📋 フェーズ概要

### 目的
システム全体の統合制御とオーケストレーションを実現するため、各モジュール間の依存関係管理、定期実行スケジューリング、システム状態監視を統合的に行う。

### 主要機能
- **システム初期化・終了制御**: 全モジュールの適切な起動・停止順序管理
- **定期実行スケジューリング**: 検出処理・分析処理の自動実行管理
- **モジュール間連携制御**: 各コンポーネント間のワークフロー制御
- **システム状態監視**: リアルタイムな健全性チェック・パフォーマンス監視
- **エラーハンドリング統合**: 障害発生時の自動復旧・継続性確保

---

## 📁 含まれるモジュール

### 1. main.py - システム中央制御モジュール
**文書番号**: 12-002-PROC-007  
**概要**: 昆虫自動観察システムの中央制御・ライフサイクル管理  

**主要クラス**: `InsectObserverSystem`

**主要機能**:
- システム全体の初期化・終了処理
- メインループ実行・監視スレッド管理
- 検出サイクル・日次分析の実行制御
- システムリソース監視・モジュール健全性チェック
- 外部API（単発検出・指定日分析）

### 2. system_controller.py - システム統合管理モジュール
**文書番号**: 12-002-PROC-008  
**概要**: 各モジュール間の連携制御と統合オーケストレーション  

**主要クラス**: `SystemController`

**主要機能**:
- モジュール間の依存関係管理・処理パイプライン制御
- 統合検出ワークフロー・統合分析ワークフローの実行
- システム健全性チェック・パフォーマンス監視
- エラー統合管理・自動復旧機能
- システム診断・メンテナンス機能

### 3. scheduler.py - スケジューラー管理モジュール
**文書番号**: 12-002-PROC-009  
**概要**: 定期的な検出・分析処理のスケジューリングと実行管理  

**主要クラス**: `SchedulerManager`

**主要機能**:
- 定期検出処理・日次分析処理のスケジューリング
- タスクキュー・ジョブ管理・実行状態監視
- スケジュール動的変更・一時停止・再開
- 障害時の自動復旧・リトライ機能
- パフォーマンス統計・監視

---

## 🔄 処理フロー概要

### システム起動・実行フロー
```
1. main.py初期化
   ↓
2. 全モジュール初期化（設定 → ハードウェア → 検出器 → 他）
   ↓
3. system_controller.py初期化
   ↓
4. scheduler.py初期化・タスクスケジューリング
   ↓
5. メインループ開始・監視スレッド開始
   ↓
6. 定期実行ループ（検出・分析・監視）
```

### 統合ワークフロー実行フロー
```
スケジューラー定期実行
   ↓
main.py：検出サイクル実行要求
   ↓
system_controller.py：統合検出ワークフロー実行
   ├─ ハードウェア前処理
   ├─ 検出実行（insect_detector）
   ├─ 結果処理（detection_processor）
   ├─ パフォーマンス指標更新
   └─ ハードウェア後処理
   ↓
main.py：検出結果記録・統計更新
```

---

## 📊 データフロー

### 主要データ構造
- **SystemStatus**: システム実行状態（稼働状態・モード・統計情報）
- **PerformanceMetrics**: パフォーマンス指標（処理時間・成功率・スループット）
- **SystemHealthStatus**: システム健全性状態（モジュール別状態・エラー・警告）
- **ScheduledTask**: スケジュールタスク（実行情報・状態・統計）

### モジュール間連携
```
main.py (中央制御)
   ├─ system_controller.py (統合管理)
   │   ├─ hardware_controller (ハードウェア制御)
   │   ├─ insect_detector (昆虫検出)
   │   ├─ detection_processor (検出処理)
   │   ├─ activity_calculator (活動量算出)
   │   └─ visualizer (可視化)
   ├─ scheduler.py (スケジューリング)
   ├─ error_handler (エラーハンドリング)
   └─ monitoring (システム監視)
```

---

## 🔧 設定・パラメータ

### 主要設定項目
- **検出間隔**: 定期検出の実行間隔（秒）
- **分析時刻**: 日次分析の実行時刻（HH:MM形式）
- **監視間隔**: システム監視の実行間隔（秒）
- **エラー閾値**: 各モジュールのエラー率警告閾値
- **リトライ設定**: タスク失敗時の最大リトライ回数・遅延時間
- **リソース制限**: 履歴データサイズ・メモリ使用量制限

### パフォーマンス要件
- **検出サイクル実行時間**: ≤ 2秒（通常条件下）
- **システム応答性**: 監視・制御コマンドへの応答時間 ≤ 1秒
- **リソース効率**: CPU使用率 ≤ 50%（アイドル時）
- **安定性**: 24時間連続稼働・自動復旧機能

---

## 📝 実装注意事項

### スレッド管理
- メインループ・監視ループ・スケジューラーループの並行実行
- スレッドセーフな状態管理・データ共有
- 適切な同期制御・デッドロック回避

### エラーハンドリング
- 各モジュールのエラー統合管理
- 障害発生時の自動復旧・継続性確保
- エラー重要度に応じた適切な対応

### リソース管理
- メモリ効率的な履歴データ管理
- ファイルハンドル・ネットワーク接続の適切な解放
- システム終了時の安全なクリーンアップ

---

## 🔄 更新履歴

| バージョン | 更新日 | 更新者 | 更新内容 |
|-----------|--------|--------|----------|
| 1.0 | 2025-07-29 | 開発チーム | 初版作成・Phase 5全体概要 |

---

## 📚 関連文書

- [基本設計書: システムアーキテクチャ設計](../../basic_design/system_architecture_design.md)
- [Phase 1: 基盤モジュール処理説明書](../phase1/README.md)
- [Phase 2: ハードウェア制御モジュール処理説明書](../phase2/README.md)
- [Phase 3: 検出モジュール処理説明書](../phase3/README.md)
- [Phase 4: 分析・可視化モジュール処理説明書](../phase4/README.md)
- [Phase 6: エラーハンドリング・監視モジュール処理説明書](../phase6/README.md)
- [要件定義書](../../../../requirements/12-002_昆虫自動観察＆ログ記録アプリ_要件定義書.md)